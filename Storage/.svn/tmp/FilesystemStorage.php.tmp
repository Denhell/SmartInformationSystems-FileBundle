<?php

namespace SmartSystems\FileBundle\Storage;

use Symfony\Component\HttpFoundation\File\UploadedFile;

use SmartSystems\FileBundle\Entity\File;

/**
 * Хранилище в файловой системе.
 *
 */
class FilesystemStorage extends AbstractStorage
{
    /**
     * {@inheritdoc}
     */
    protected function init()
    {
        parent::init();

        if (!is_dir($this->getParam('path'))) {
            mkdir($this->getParam('path'), '0555', TRUE);
        }
    }

    /**
     * {@inheritdoc}
     */
    public function getUrl($file)
    {
        return $this->getParam('url') . $file->getExternalToken();
    }

    /**
     * {@inheritdoc}
     */
    public function store(UploadedFile $uploadedFile)
    {
        $class = $this->getEntityClass();

        /** @var File $file */
        $file = new $class($uploadedFile);

        $path = substr($file->getToken(), 0, 2) . '/' . substr($file->getToken(), 2, 2) . '/';

        $filename = $file->getToken() . '.' . $uploadedFile->getClientOriginalExtension();

        $uploadedFile->move($this->getParam('path') . '/' . $path, $filename);

        $file->setExternalToken($path . $filename);

        $this->getEntityManager()->persist($file);

        return $file;
    }
}
